default_platform(:ios)

platform :ios do
  # ──────────────────────────────────────────────────────────────────
  # Lane: setup_app
  # Creates the App ID + App Store Connect entry if it doesn't exist.
  # Usage: fastlane ios setup_app
  # ──────────────────────────────────────────────────────────────────
  desc "Create app on App Store Connect via API (bundle ID + app record)"
  lane :setup_app_api do
    create_app_api(
      app_name: "iWorkr",
      bundle_id: "com.iworkr.app",
      sku: "com.iworkr.app.ios"
    )
  end

  desc "Register the app on Apple Developer Portal and App Store Connect"
  lane :setup_app do
    ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"] = ENV["ASC_KEY_ID"]
    ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"] = ENV["ASC_ISSUER_ID"]
    ENV["APP_STORE_CONNECT_API_KEY_KEY_CONTENT"] = ENV["ASC_KEY_CONTENT"]
    ENV["APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64"] = "true"

    produce(
      app_identifier: "com.iworkr.app",
      app_name: "iWorkr",
      language: "English",
      app_version: "1.0.0",
      sku: "com.iworkr.app.ios",
      platform: "ios"
    )
  end

  # ──────────────────────────────────────────────────────────────────
  # Lane: deploy_ios
  # Builds the Flutter app (including Widget Extension), increments
  # the build number, and uploads the binary to TestFlight.
  # Usage: fastlane ios deploy_ios
  # ──────────────────────────────────────────────────────────────────
  desc "Build and upload to TestFlight"
  lane :deploy_ios do
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY_CONTENT"],
      is_key_content_base64: true,
      in_house: false
    )

    # 1. Build Flutter first (produces the Runner.app / .xcarchive artifacts)
    sh("cd ../.. && flutter build ios --release --no-codesign")

    # 2. Increment build number (auto-increment based on latest TestFlight build)
    latest = begin
      latest_testflight_build_number(
        api_key: api_key,
        app_identifier: "com.iworkr.app"
      )
    rescue => e
      UI.important("Could not fetch latest build number: #{e.message}")
      UI.important("Using build number 1 (run setup_app first if the app does not exist)")
      0
    end
    increment_build_number(
      build_number: latest + 1,
      xcodeproj: "Runner.xcodeproj"
    )

    # 3. Build the signed IPA (allow Xcode to create/update provisioning profiles)
    #    -allowProvisioningUpdates lets Xcode auto-manage profiles for both
    #    the main app AND the widget extension target.
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      output_name: "iWorkr.ipa",
      xcargs: "-allowProvisioningUpdates"
    )

    # 4. Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      skip_submission: false
    )

    UI.success("iWorkr uploaded to TestFlight!")
  end

  # ──────────────────────────────────────────────────────────────────
  # Lane: build_only
  # Builds the IPA without uploading. Useful for local testing.
  # Usage: fastlane ios build_only
  # ──────────────────────────────────────────────────────────────────
  desc "Build IPA without uploading"
  lane :build_only do
    sh("cd ../.. && flutter build ios --release --no-codesign")

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      output_name: "iWorkr.ipa",
      xcargs: "-allowProvisioningUpdates"
    )
  end
end
